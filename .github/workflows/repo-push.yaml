name: Build Repository Infrastructure

on:
    schedule:
        # Rebuild repo twice daily to catch any package updates
        - cron: "0 6,18 * * *"
    push:
        branches: [main]
        paths:
            - repo/**
            - packages/**
    workflow_dispatch:
        inputs:
            rebuild_all:
                description: 'Force rebuild all packages'
                required: false
                default: 'false'
                type: boolean

jobs:
    build-and-push-repo:
        name: Build and Push Repository Image
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: |
                      ghcr.io/${{ github.repository }}-repo
                  tags: |
                      type=ref,event=branch
                      type=sha,prefix={{branch}}-
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push repo image
              uses: docker/build-push-action@v5
              with:
                  context: ./repo
                  file: ./repo/Dockerfile
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Test repository functionality
              run: |
                  echo "Testing repository functionality..."
                  
                  # Start the repo container
                  docker run -d --name test-repo \
                      -p 8000:8000 \
                      -v ${{ github.workspace }}/packages:/coderunr/packages:ro \
                      ghcr.io/${{ github.repository }}-repo:latest
                  
                  # Wait for startup and index generation
                  echo "Waiting for container startup and index generation..."
                  sleep 20
                  
                  # Test basic HTTP functionality
                  if curl -f http://localhost:8000/; then
                      echo "‚úÖ Repository server is responding"
                  else
                      echo "‚ùå Repository server failed to start"
                      docker logs test-repo
                      exit 1
                  fi
                  
                  # Test package index
                  if curl -f http://localhost:8000/index | head -5; then
                      echo "‚úÖ Package index is accessible"
                  else
                      echo "‚ö†Ô∏è  Package index may be empty (this is normal for new deployments)"
                  fi
                  
                  # Show container logs for debugging
                  echo "Container logs:"
                  docker logs test-repo
                  
                  # Cleanup
                  docker stop test-repo
                  docker rm test-repo

                  echo "üéâ Repository test completed successfully!"
